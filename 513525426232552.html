<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ALTAI-BAD — Голосовой консультант по здоровью</title>
  <style>
    :root{
      --brand:#0b7a4a;
      --brand-600:#0a6a41;
      --brand-50:#e8f5ef;
      --ink:#0f172a;
      --muted:#475569;
      --bg:#f6f7f8;
      --radius:28px;
      --ring:#e8f7f0;
      --pad:clamp(16px, 4vw, 24px);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}

    .wrap{min-height:100svh;min-height:100dvh;display:grid;place-items:center;padding:calc(var(--pad) + env(safe-area-inset-top)) var(--pad) calc(var(--pad) + env(safe-area-inset-bottom));}

    .card{width:100%;max-width:640px;background:#fff;border-radius:36px;box-shadow:0 24px 80px rgba(15,23,42,.12);border:1px solid #eef4f1;position:relative;max-height:calc(100dvh - 2*var(--pad) - env(safe-area-inset-top) - env(safe-area-inset-bottom));}
    .card::after{content:"";position:absolute;inset:0;border-radius:40px;pointer-events:none}
    .inner{padding:clamp(18px, 4.5vw, 28px);overflow:auto;-webkit-overflow-scrolling:touch}

    .brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .brand svg{width:clamp(28px, 7vw, 36px);height:auto}
    .brand-title{font-weight:800;letter-spacing:.5px;color:var(--brand);font-size:clamp(22px, 6vw, 28px)}

    .h1{font-size:clamp(22px, 7.5vw, 36px);line-height:1.15;font-weight:800;color:#0f172a;margin:18px 0 10px}
    .lead{font-size:clamp(16px, 5.3vw, 22px);line-height:1.35;color:#111827;opacity:.9;margin:0}

    .mic-wrap{display:grid;place-items:center;margin:clamp(16px, 5vw, 26px) 0}
    .mic-ring{width:clamp(200px, 56vw, 264px);height:clamp(200px, 56vw, 264px);border-radius:999px;background:radial-gradient(closest-side, #0e7146 0%, #085e3a 90%);display:grid;place-items:center;box-shadow:0 20px 60px rgba(11,122,74,.35), inset 0 0 0 14px #e9f6f0, inset 0 0 0 28px #f4fbf7;transition:all 0.3s ease;}
    .mic-ring.listening{background:radial-gradient(closest-side, #dc2626 0%, #991b1b 90%);box-shadow:0 20px 60px rgba(220,38,38,.35), inset 0 0 0 14px #fee2e2, inset 0 0 0 28px #fef2f2;}
    .mic-ring.speaking{background:radial-gradient(closest-side, #f59e0b 0%, #d97706 90%);box-shadow:0 20px 60px rgba(245,158,11,.35), inset 0 0 0 14px #fef3c7, inset 0 0 0 28px #fffbeb;}
    .mic-btn{width:clamp(148px, 40vw, 188px);height:clamp(148px, 40vw, 188px);border-radius:999px;border:none;background:var(--brand);color:#fff;display:grid;place-items:center;cursor:pointer;box-shadow:0 14px 30px rgba(11,122,74,.35);transition:transform .08s ease}
    .mic-btn:active{transform:scale(.98)}
    .mic-btn.listening{background:#dc2626;animation:pulse 1.5s infinite;}
    .mic-btn.speaking{background:#f59e0b;}
    .mic-btn svg{width:clamp(44px, 11vw, 68px);height:auto}

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .hint{font-size:clamp(16px, 5.3vw, 22px);line-height:1.35;color:#111827;text-align:center;opacity:.9;margin:6px 0 16px}

    .grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:clamp(8px, 3.5vw, 14px);margin-top:8px}
    .chip{display:flex;align-items:center;gap:12px;justify-content:center;padding:clamp(12px, 3.2vw, 16px) clamp(14px, 3.8vw, 18px);border-radius:16px;border:1px solid #e5e7eb;background:#fff;color:#134e35;font-weight:600;font-size:clamp(16px, 4.8vw, 20px);min-height:48px;touch-action:manipulation;cursor:pointer;transition:all 0.2s ease;}
    .chip:hover{background:#f7faf8;transform:translateY(-1px);}
    .chip svg{width:clamp(22px, 6vw, 28px);height:auto}

    @media (max-width:360px){
      .grid{grid-template-columns:1fr}
      .card{border-radius:28px}
    }

    .status{color:#64748b;font-size:clamp(12px,3.6vw,14px);margin-top:8px;white-space:pre-wrap;text-align:center;min-height:20px;}
    .status.speaking{color:#f59e0b;font-weight:600;}
    .status.listening{color:#dc2626;font-weight:600;}
    .error{display:none;background:#fee2e2;border:1px solid #fecaca;color:#b91c1c;border-radius:12px;padding:10px;margin:12px auto 0;max-width:520px;font-size:14px}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:50;padding:var(--pad)}
    .overlay-card{background:#fff;border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.35);padding:22px;max-width:420px;width:100%;text-align:center}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:12px 18px;font-weight:700;cursor:pointer;transition:background 0.2s ease;}
    .btn:hover{background:var(--brand-600);}    
    .btn-muted{background:#e5e7eb;color:#111827}

    .tts-info{background:#f0f9ff;border:1px solid #0ea5e9;color:#0c4a6e;border-radius:8px;padding:8px;margin:8px auto 0;max-width:520px;font-size:12px;text-align:center;}

    @media (prefers-reduced-motion: reduce){
      .mic-btn{transition:none}
      .mic-ring{transition:none}
      .chip{transition:none}
      .btn{transition:none}
      .mic-btn.listening{animation:none}
    }
  </style>
</head>
<body>
  <!-- Оверлей разблокировки аудио + первичного запроса разрешения -->
  <div id="overlay" class="overlay">
    <div class="overlay-card">
      <h3 style="margin:0 0 6px 0">Включите голосового консультанта</h3>
      <p style="margin:0 0 14px 0;color:#374151">Нажмите один раз — я разблокирую звук и попрошу доступ к микрофону (если нужно).</p>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button id="unlockBtn" class="btn">Включить звук</button>
        <button id="askMicFromOverlay" class="btn btn-muted">Разрешить микрофон</button>
      </div>
      <div id="overlayHint" style="font-size:12px;color:#6b7280;margin-top:10px;line-height:1.3"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="inner">
        <div class="brand" aria-label="ALTAI-BAD">
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M6 48l16-26 10 16 8-10 18 20H6z" fill="#0b7a4a"/>
            <path d="M22 22l6 10 2-3-8-7z" fill="#fff"/>
          </svg>
          <div class="brand-title">ALTAI-BAD</div>
        </div>

        <div class="h1">Ваш консультант по здоровью</div>
        <p class="lead">Помогу подобрать натуральные средства<br/>по симптомам и диагнозам</p>

        <div class="mic-wrap">
          <div id="micRing" class="mic-ring">
            <button id="micBtn" class="mic-btn" title="Спросить голосом">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M12 1.75a3.25 3.25 0 0 0-3.25 3.25v6a3.25 3.25 0 0 0 6.5 0v-6A3.25 3.25 0 0 0 12 1.75Z"/>
                <path d="M5 11.5a7 7 0 0 0 14 0"/>
                <path d="M12 18.5v3"/>
              </svg>
            </button>
          </div>
        </div>

        <p class="hint">Расскажите о своих симптомах или задайте вопрос о товарах</p>

        <div class="grid">
          <button class="chip" data-intent="health" aria-label="Товары для здоровья">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            Товары для здоровья
          </button>
          <button class="chip" data-intent="delivery" aria-label="Доставка">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 7h12v10H3z"/><path d="M15 10h4l3 3v4h-7V10z"/><circle cx="7.5" cy="17" r="1.5"/><circle cx="17.5" cy="17" r="1.5"/></svg>
            Доставка
          </button>
          <button class="chip" data-intent="consultation" aria-label="Консультация">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 11H7a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-2M9 11V9a2 2 0 0 1 2-2v0a2 2 0 0 1 2 2v2M9 11h6"/></svg>
            Консультация
          </button>
          <button class="chip" data-intent="contact" aria-label="Связаться">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.1 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.9.3 1.77.57 2.61a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.47-1.14a2 2 0 0 1 2.11-.45c.84.27 1.71.45 2.61.57A2 2 0 0 1 22 16.92Z"/></svg>
            Связаться
          </button>
        </div>

        <div id="status" class="status">Готова помочь. Нажмите «Включить звук», затем говорите или выберите тему.</div>
        <div id="ttsInfo" class="tts-info"></div>
        <div id="errorBox" class="error"></div>
        <div style="display:flex;justify-content:center">
          <button id="retryMicBtn" class="btn" style="display:none;margin-top:8px">Повторить запрос доступа к микрофону</button>
        </div>
      </div>
    </div>
  </div>

<script>
// ====== Mobile viewport fix ======
(function(){
  function setVH(){
    const vv=(window.visualViewport&&visualViewport.height)||window.innerHeight;
    document.documentElement.style.setProperty('--vh', vv+'px');
  }
  setVH();
  window.addEventListener('resize', setVH);
  window.visualViewport && visualViewport.addEventListener('resize', setVH);
})();

window.addEventListener('DOMContentLoaded', ()=>{
'use strict'

// ===== Определение устройства и возможностей =====
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
         (window.innerWidth <= 768) ||
         ('ontouchstart' in window);
}

function isIOSDevice() {
  return /iPad|iPhone|iPod/.test(navigator.userAgent);
}

function isSecure(){
  return (window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost');
}

function canUseElevenLabs() {
  if (isMobileDevice()) return false; // на мобилках чаще блоки/ограничения
  return !!(window.fetch && window.AbortController);
}

// ===== TTS Конфигурация =====
const TTS_CONFIG = {
  openai: {
    apiKey: '', // <-- добавьте ключ при необходимости
    model: 'tts-1',
    voice: 'shimmer',
    format: 'mp3',
    speed: 0.95,
    timeoutMs: 15000,
  },
  elevenlabs: {
    apiKey: '', // <-- добавьте ключ при необходимости
    voiceId: 'ymDCYd8puC7gYjxIamPt',
    model: 'eleven_multilingual_v2',
    timeoutMs: 25000,
  },
  getPreferredTTS(){
    if (canUseElevenLabs() && this.elevenlabs.apiKey) return 'elevenlabs';
    if (this.openai.apiKey) return 'openai';
    return 'browser';
  }
};

// ===== Глобальные переменные =====
const player = new Audio();
player.preload = 'auto';
const SILENCE_WAV = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAAACAAAAVGFkYQAAAAAA';

// UI элементы
const overlay = document.getElementById('overlay');
const overlayHint = document.getElementById('overlayHint');
const unlockBtn = document.getElementById('unlockBtn');
const askMicFromOverlay = document.getElementById('askMicFromOverlay');
const statusEl = document.getElementById('status');
const errorBox = document.getElementById('errorBox');
const ttsInfo = document.getElementById('ttsInfo');
const micBtn = document.getElementById('micBtn');
const micRing = document.getElementById('micRing');
const retryMicBtn = document.getElementById('retryMicBtn');

// Состояние
let isListening = false;
let isSpeaking = false;
let recognition = null;
let speakQueue = [];
let audioUnlocked = false;
let recognitionTimeout = null;
let currentTTSProvider = 'browser';
let microphoneReady = false;
let micPermission = 'unknown';

// ===== Утилиты UI =====
function setStatus(text, type = 'default'){ 
  statusEl.textContent = text;
  statusEl.className = `status ${type}`;
  console.log('[Status]', text);
}

function showError(text){ 
  console.error('[Error]', text);
  errorBox.style.display = 'block'; 
  errorBox.textContent = '⚠️ ' + text;
  setTimeout(() => { errorBox.style.display = 'none'; }, 6000);
}

function showTTSInfo(text) {
  ttsInfo.textContent = text;
  ttsInfo.style.display = 'block';
  setTimeout(() => { ttsInfo.style.display = 'none'; }, 4000);
}

function updateVisualState() {
  micBtn.className = 'mic-btn' + 
    (isListening ? ' listening' : '') + 
    (isSpeaking ? ' speaking' : '');
  micRing.className = 'mic-ring' + 
    (isListening ? ' listening' : '') + 
    (isSpeaking ? ' speaking' : '');
}

// ===== Подсказки для разрешений =====
function renderPermissionHint(state){
  let hint = '';
  if (!isSecure()) {
    hint += 'Сайт открыт не по HTTPS. Откройте безопасную версию: https://' + location.host + location.pathname + location.search + '.\n';
  }
  if (state === 'denied') {
    hint += (isIOSDevice()
      ? 'Safari (iOS): Настройки > Safari > Камера и микрофон > Разрешить, затем снова откройте страницу.'
      : 'Chrome/Android: Нажмите на значок замка в адресной строке → Разрешения сайта → Микрофон → Разрешить, затем обновите страницу.'
    );
  } else if (state === 'prompt') {
    hint += 'Сейчас появится системный запрос. Нажмите «Разрешить».';
  }
  overlayHint.textContent = hint;
}

// ===== Проверка/запрос разрешения на микрофон =====
async function getMicPermissionState(){
  if (!navigator.permissions || !navigator.permissions.query) return 'unknown';
  try {
    const status = await navigator.permissions.query({ name: 'microphone' });
    micPermission = status.state;
    status.onchange = () => { micPermission = status.state; };
    return status.state;
  } catch { return 'unknown'; }
}

async function ensureMicAccess({forcePrompt=false}={}){
  if (!isSecure()) { showError('Для работы микрофона нужен HTTPS (или localhost).'); return false; }
  if (!navigator.mediaDevices?.getUserMedia) { showError('Браузер не поддерживает getUserMedia. Используйте Chrome, Safari или Samsung Internet.'); return false; }

  let state = await getMicPermissionState();
  if (state === 'granted' && !forcePrompt) {
    microphoneReady = true;
    retryMicBtn.style.display = 'none';
    return true;
  }

  renderPermissionHint(state || 'unknown');
  try {
    await navigator.mediaDevices.getUserMedia({ audio: true });
    microphoneReady = true;
    retryMicBtn.style.display = 'none';
    setStatus('Микрофон готов. Нажмите большую кнопку и говорите.');
    return true;
  } catch (error) {
    microphoneReady = false;
    console.warn('[Mic] getUserMedia failed:', error);
    let msg = 'Не удалось получить доступ к микрофону';
    if (error.name === 'NotAllowedError') msg = 'Доступ к микрофону запрещён. Разрешите микрофон в настройках сайта и обновите страницу.';
    else if (error.name === 'NotFoundError') msg = 'Микрофон не найден. Подключите устройство записи и попробуйте снова.';
    else if (error.name === 'NotReadableError') msg = 'Микрофон занят другим приложением.';
    else if (error.name === 'SecurityError') msg = 'Безопасность браузера блокирует микрофон (проверьте HTTPS).';
    showError(msg);
    retryMicBtn.style.display = 'inline-block';
    return false;
  }
}

// ===== Экспертная база знаний (как было) =====
function getHealthAdvice(text) {
  const t = text.toLowerCase().trim();
  if(/сустав|артрит|артроз|позвоночник|спина|остеохондроз|радикулит|ревматизм|болит спина|болят суставы/.test(t)) {
    return 'При проблемах с суставами и позвоночником рекомендую обратить внимание на наши алтайские бальзамы с пантами марала, живицу кедровую и каменное масло. Эти натуральные средства помогают снизить воспаление и улучшить подвижность. Также полезны фитокомплексы для суставов. Хотите подробнее узнать о конкретном средстве?';
  }
  if(/желудок|кишечник|гастрит|язва|изжога|колит|пищеварение|запор|диарея|живот болит/.test(t)) {
    return 'Для здоровья желудочно-кишечного тракта у нас есть специальные травяные сборы: алтайский чай с травами, бальзамы на основе облепихи и прополиса. Рекомендую также масло кедрового ореха - оно мягко восстанавливает слизистую. При серьезных проблемах обязательно консультируйтесь с врачом.';
  }
  if(/иммунитет|простуда|грипп|орви|кашель|насморк|горло|температура|заболел|простыл/.test(t)) {
    return 'Для укрепления иммунитета отлично подходят: алтайский мед с пантами, экстракт эхинацеи, травяные сборы с шиповником и облепихой. При первых признаках простуды помогают сиропы "Бобродок", живица кедровая. Всё это натуральные средства без химии.';
  }
  if(/женское здоровье|менопауза|климакс|цистит|молочница|месячные|гормоны|женские проблемы/.test(t)) {
    return 'У нас широкий выбор средств для женского здоровья: фитосвечи с боровой маткой и красной щеткой, бальзамы для интимного здоровья, травяные сборы для нормализации цикла. Красная щетка особенно эффективна при гормональных нарушениях.';
  }
  if(/мужское здоровье|потенция|простатит|либидо|мужская сила|мужские проблемы/.test(t)) {
    return 'Для мужского здоровья рекомендуем: панты марала - природный источник силы, бальзам "Мужская энергия", продукты с живицей кедровой, секрет бобра. Эти средства веками использовались на Алтае для поддержания мужской силы.';
  }
  if(/сердце|давление|гипертония|холестерин|сосуды|атеросклероз|сердечные|кардио/.test(t)) {
    return 'Для сердечно-сосудистой системы полезны: каменное масло - снижает давление, боярышник в составе травяных сборов, пантовые продукты для укрепления сосудов. Обязательно контролируйте давление и консультируйтесь с кардиологом.';
  }
  if(/печень|гепатит|желчный|холецистит|детокс|очищение|печеночные/.test(t)) {
    return 'Для здоровья печени и очищения организма: расторопша в составе сборов, каменное масло, травяные чаи с бессмертником, натуральные бальзамы для детоксикации. Эти средства мягко поддерживают работу печени.';
  }
  if(/нервы|стресс|депрессия|бессонница|сон|тревога|невроз|нервная система/.test(t)) {
    return 'При стрессах и проблемах со сном помогают: успокаивающие травяные сборы с пустырником и валерианой, алтайские бальзамы с адаптогенами, чаи для релаксации. Натуральные средства действуют мягко, без привыкания.';
  }
  if(/диабет|сахар|глюкоза|инсулин|сахарный/.test(t)) {
    return 'При диабете могут помочь: травяные сборы с черникой и створками фасоли, каменное масло для нормализации обмена веществ, топинамбур в различных формах. ВАЖНО: эти средства - дополнение к основному лечению, не заменяют лекарства!';
  }
  if(/похудение|лишний вес|диета|метаболизм|жир|целлюлит|худеть|похудеть/.test(t)) {
    return 'Для нормализации веса: травяные чаи для ускорения метаболизма, бурый рис и другие продукты здорового питания, натуральные бальзамы для улучшения обмена веществ, алтайские ягоды годжи.';
  }
  return null;
}

function replyFor(text){
  const t = text.toLowerCase().trim();
  const healthAdvice = getHealthAdvice(text);
  if(healthAdvice) return healthAdvice;
  if(/здравствуй|привет|добрый|доброе|хай|ку-ку|алло|добро пожаловать/.test(t)) {
    return 'Здравствуйте! Меня зовут Анна, я ваш консультант по натуральным средствам от ALTAI-BAD. Помогаю подобрать товары для здоровья по симптомам и диагнозам. Расскажите, что вас беспокоит, или задайте любой вопрос о наших товарах.';
  }
  if(/доставк|курьер|почт|получ|привез|сдэк|транспорт/.test(t)) {
    return 'Доставляем по всей России курьерами и Почтой России. Курьерская доставка от 900 рублей, от 1 дня до порога вашего дома. При заказе полного курса лечения - доставка бесплатная за наш счёт! В какой город вам нужна доставка?';
  }
  if(/оплат|карт|деньг|стоимост|цен|сколько|руб|банк|платеж/.test(t)) {
    return 'У нас три удобных способа оплаты: онлайн банковской картой или через СБП, наличными на почте при получении, или курьеру при доставке. Все платежи защищены. Какой способ вам удобнее?';
  }
  if(/товар|каталог|ассортимент|что есть|что продаете|бад|средства|продукц/.test(t)) {
    return 'У нас более 7000 натуральных товаров для здоровья: панты марала, алтайские бальзамы, живица кедровая, каменное масло, травяные сборы, натуральная косметика, мед и продукты пчеловодства. Все средства от алтайских производителей. О какой категории товаров хотите узнать?';
  }
  if(/консультац|подбор|посовет|рекоменд|помог|выбрать|подскаж/.test(t)) {
    return 'Я подберу натуральные средства индивидуально под ваши потребности. Расскажите о ваших симптомах, диагнозах или проблемах со здоровьем. Также можете звонить нашим специалистам: 8-903-930-41-52 для детальной консультации.';
  }
  if(/телефон|контакт|связ|номер|звон|позвон/.test(t)) {
    return 'Наш телефон для справок: 8-903-930-41-52. Работаем с высококачественными натуральными средствами, обеспечиваем поддержку опытных специалистов на каждом этапе вашего оздоровления. Звоните, поможем!';
  }
  if(/компан|altai|алтай|производ|качество|откуда|кто вы/.test(t)) {
    return 'ALTAI-BAD - магазин натуральных товаров для здоровья с индивидуальным подбором по диагнозам и симптомам. Работаем напрямую с производителями Алтая, гарантируем качество всех товаров. Используем только высококачественные и безопасные натуральные средства.';
  }
  if(/спасиб|благодар|класс|супер|отлично|хорошо|замечательно/.test(t)) {
    return 'Очень приятно помочь! Забота о вашем здоровье - основа нашей работы. Если возникнут еще вопросы или нужна будет консультация - обращайтесь в любое время.';
  }
  if(/пока|до свидан|досвидан|бай|увидимся/.test(t)) {
    return 'Всегда рада помочь! Берегите здоровье, выбирайте натуральное. До свидания!';
  }
  if(/помощ|что умеешь|что можешь|функции|возможности/.test(t)) {
    return 'Я помогаю подбирать натуральные средства для здоровья по симптомам и диагнозам, консультирую по товарам ALTAI-BAD, рассказываю о доставке и оплате. Просто опишите ваши потребности или задайте любой вопрос!';
  }
  return 'Расскажите подробнее о ваших потребностях или симптомах, и я подберу подходящие натуральные средства. Также могу ответить на вопросы о доставке, оплате или конкретных товарах нашего магазина.';
}

// ===== Провайдеры TTS =====
async function speakWithElevenLabs(text) {
  if (!TTS_CONFIG.elevenlabs.apiKey) throw new Error('ElevenLabs API key not configured');
  const url = `https://api.elevenlabs.io/v1/text-to-speech/${TTS_CONFIG.elevenlabs.voiceId}/stream`;
  const payload = { text: text.substring(0, 2000), model_id: TTS_CONFIG.elevenlabs.model, voice_settings:{ stability:0.6, similarity_boost:0.8, use_speaker_boost:true }, output_format:'mp3_22050_32' };
  const response = await fetch(url, { method:'POST', headers:{ 'Accept':'audio/mpeg', 'Content-Type':'application/json', 'xi-api-key':TTS_CONFIG.elevenlabs.apiKey }, body: JSON.stringify(payload) });
  if(!response.ok) throw new Error('ElevenLabs HTTP '+response.status);
  const blob = await response.blob();
  const urlObj = URL.createObjectURL(blob);
  try { await playAudioUrl(urlObj); } finally { URL.revokeObjectURL(urlObj); }
}

async function speakWithOpenAI(text){
  if (!TTS_CONFIG.openai.apiKey) throw new Error('OpenAI API key not configured');
  const response = await fetch('https://api.openai.com/v1/audio/speech', { method:'POST', headers:{ 'Authorization':`Bearer ${TTS_CONFIG.openai.apiKey}`, 'Content-Type':'application/json' }, body: JSON.stringify({ model:TTS_CONFIG.openai.model, voice:TTS_CONFIG.openai.voice, input:text.substring(0,4096), response_format:TTS_CONFIG.openai.format, speed:TTS_CONFIG.openai.speed }) });
  if(!response.ok) throw new Error('OpenAI HTTP '+response.status);
  const blob = await response.blob();
  const urlObj = URL.createObjectURL(blob);
  try { await playAudioUrl(urlObj); } finally { URL.revokeObjectURL(urlObj); }
}

function getRuVoice(){ 
  const voices = speechSynthesis.getVoices(); 
  const femaleRuVoices = voices.filter(v => /ru/i.test(v.lang) && (/female|woman|anna|elena|marina|svetlana|irina/i.test(v.name) || v.name.includes('ж')));
  if(femaleRuVoices[0]) return femaleRuVoices[0];
  const ruVoices = voices.filter(v => /ru/i.test(v.lang));
  return ruVoices[0] || voices[0];
}

function speakViaSpeechSynthesis(text){
  return new Promise(resolve => { 
    try{ 
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text); 
      const voice = getRuVoice(); 
      if(voice){ u.voice = voice; u.lang = 'ru-RU'; }
      u.rate = isMobileDevice()?0.9:0.85; u.pitch = 1.0; u.volume = 0.9;
      u.onend = resolve; u.onerror = () => resolve();
      speechSynthesis.speak(u);
    } catch{ resolve(); } 
  });
}

function splitTextIntoChunks(text, maxLength = 160){ 
  const chunks = []; if(!text) return chunks; 
  const sentences = text.split(/[.!?]\s+/).filter(s => s.trim());
  let cur = '';
  for(const s of sentences){
    if((cur + s).length > maxLength && cur){ chunks.push(cur.trim()+'.'); cur = s; } else { cur += (cur?'. ':'') + s; }
  }
  if(cur.trim()) chunks.push(cur.trim() + (cur.endsWith('.')?'':'.'));
  return chunks.length?chunks:[text];
}

async function speak(text){ 
  if(!audioUnlocked){ console.warn('[TTS] Audio not unlocked'); return; }
  const parts = splitTextIntoChunks(String(text||''), 160); 
  for(const p of parts){ speakQueue.push(p); } 
  if(!isSpeaking) processQueue();
}

async function processQueue(){ 
  if(isSpeaking || !speakQueue.length) return; 
  isSpeaking = true; updateVisualState(); setStatus('Говорю...', 'speaking');
  const text = speakQueue.shift(); 
  try{ 
    if (currentTTSProvider === 'elevenlabs')      await speakWithElevenLabs(text);
    else if (currentTTSProvider === 'openai')     await speakWithOpenAI(text);
    else                                          await speakViaSpeechSynthesis(text);
  } catch(e){ 
    showError(`TTS ошибка: ${e.message}. Переключаюсь на голос браузера.`);
    currentTTSProvider = 'browser';
    await speakViaSpeechSynthesis(text);
  } finally { 
    isSpeaking = false; updateVisualState();
    if(speakQueue.length) setTimeout(processQueue, 200); else setStatus('Готова ответить на ваши вопросы');
  } 
}

function playAudioUrl(url){ 
  return new Promise((resolve, reject) => { 
    player.src = url; player.onended = resolve; player.onerror = reject; 
    const p = player.play(); if(p && p.then) p.then(()=>{}).catch(reject);
  }); 
}

// ===== Распознавание речи =====
function initSpeechRecognition(){ 
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; 
  if(!SpeechRecognition){ showError('Ваш браузер не поддерживает распознавание речи. Используйте Chrome/Safari.'); return null; }
  const rec = new SpeechRecognition(); 
  rec.lang = 'ru-RU'; rec.interimResults = true; rec.continuous = false; rec.maxAlternatives = 1;
  let finalTranscript = ''; let hasResults = false;
  rec.onstart = () => { finalTranscript=''; hasResults=false; isListening=true; updateVisualState(); setStatus('Слушаю... Говорите!', 'listening'); recognitionTimeout = setTimeout(()=>{ try{ rec.stop(); }catch{} },10000); };
  rec.onresult = (e) => { hasResults = true; let interim=''; for(let i=e.resultIndex;i<e.results.length;i++){ const r=e.results[i]; if(r.isFinal){ finalTranscript += r[0].transcript; } else { interim += r[0].transcript; } } if(interim.trim()) setStatus(`Слышу: "${interim}"`, 'listening'); };
  rec.onend = () => { if(recognitionTimeout) { clearTimeout(recognitionTimeout); recognitionTimeout=null; } isListening=false; updateVisualState(); const t = finalTranscript.trim(); if(t){ setStatus(`Вы сказали: "${t}"`); const reply = replyFor(t); setTimeout(()=>speak(reply), 500); } else if(hasResults){ setStatus('Не расслышала четко. Попробуйте еще раз.'); } else { setStatus('Речь не обнаружена. Говорите громче и четче.'); } };
  rec.onerror = (event) => { if(recognitionTimeout){ clearTimeout(recognitionTimeout); recognitionTimeout=null; } isListening=false; updateVisualState(); let msg='Ошибка распознавания речи'; switch(event.error){ case 'not-allowed': msg='Нет доступа к микрофону. Разрешите использование микрофона в настройках браузера.'; retryMicBtn.style.display='inline-block'; break; case 'no-speech': msg='Речь не обнаружена. Говорите громче и четче.'; break; case 'network': msg='Ошибка сети. Проверьте интернет.'; break; case 'audio-capture': msg='Проблема с захватом аудио. Проверьте микрофон.'; break; } showError(msg); setStatus('Готова ответить на ваши вопросы'); };
  return rec;
}

// ===== Обработчики =====
async function handleMicRequest(){
  const ok = await ensureMicAccess({ forcePrompt:true });
  if(ok) setStatus('Микрофон готов. Нажмите большую кнопку и говорите.');
}

micBtn.addEventListener('click', async () => { 
  console.log('[Mic Button] click', { isListening, isSpeaking, audioUnlocked, microphoneReady, micPermission });
  if(!audioUnlocked){ showError('Сначала включите звук (кнопка сверху).'); return; }
  if(isSpeaking){ speakQueue.length=0; player.pause(); speechSynthesis.cancel(); isSpeaking=false; updateVisualState(); setStatus('Готова ответить на ваши вопросы'); return; }
  if(isListening){ try{ recognition && recognition.stop(); }catch{} return; }
  const ok = await ensureMicAccess({ forcePrompt:true });
  if(!ok) return;
  recognition = initSpeechRecognition();
  if(!recognition) return;
  try { recognition.start(); } catch(e){ console.warn('[Recognition] start failed', e); }
});

retryMicBtn.addEventListener('click', handleMicRequest);
askMicFromOverlay.addEventListener('click', handleMicRequest);

// Быстрые ответы
for (const button of document.querySelectorAll('.chip')){
  button.addEventListener('click', () => {
    if(!audioUnlocked){ showError('Сначала включите звук'); return; }
    const intent = button.getAttribute('data-intent');
    let reply = '';
    switch(intent){
      case 'health': reply='У нас более 7000 натуральных товаров для здоровья: панты марала, алтайские бальзамы, живица кедровая, каменное масло, травяные сборы, натуральная косметика. Расскажите, какие у вас проблемы со здоровьем, и я подберу подходящие средства.'; break;
      case 'delivery': reply='Доставляем по всей России курьерами и Почтой России. Курьерская доставка от 900 рублей, от 1 дня до порога дома. При заказе полного курса лечения - доставка бесплатная! В какой город нужна доставка?'; break;
      case 'consultation': reply='Я подберу натуральные средства под ваши потребности. Опишите симптомы или проблемы со здоровьем. Для детальной консультации звоните специалистам: 8-903-930-41-52.'; break;
      case 'contact': reply='Телефон для справок: 8-903-930-41-52. Работаем с натуральными средствами, обеспечиваем поддержку специалистов. Чем еще могу помочь?'; break;
      default: reply='Готова помочь. Расскажите подробнее, что вас интересует.';
    }
    speak(reply);
  });
}

// Приветствие и разблокировка аудио
function greet(){ 
  speak('Здравствуйте! Меня зовут Анна, я ваш консультант по натуральным средствам для здоровья от компании Алтай Бад. Помогаю подобрать товары. Расскажите, чем могу помочь?');
}

async function unlockAudio(){
  try{ 
    if(!isSecure()) renderPermissionHint('unknown');
    currentTTSProvider = TTS_CONFIG.getPreferredTTS();
    const deviceInfo = isMobileDevice() ? 'мобильном устройстве' : 'компьютере';
    showTTSInfo(currentTTSProvider==='elevenlabs' ? 'Использую высококачественный голос ElevenLabs' : (currentTTSProvider==='openai' ? 'Использую голос OpenAI' : `Использую встроенный голос браузера на ${deviceInfo}`));
    player.src = SILENCE_WAV; try{ await player.play(); }catch{} player.pause();
    if('speechSynthesis' in window) speechSynthesis.getVoices();
    audioUnlocked = true;    
  } finally {
    overlay.style.display = 'none'; overlay.setAttribute('aria-hidden','true');
    setStatus('Готова ответить на ваши вопросы');
    setTimeout(greet, 800);
  }
}

unlockBtn.addEventListener('click', unlockAudio);
overlay.addEventListener('click', (e) => { if(e.target === overlay) unlockAudio(); });

// ===== Стартовые проверки =====
try{ 
  if(!isSecure()){ showError('Для голосового ввода нужен HTTPS или localhost. Функции распознавания будут ограничены.'); setStatus('Работаю в ограниченном режиме'); }
  console.log('[Init] Device:', isMobileDevice() ? 'Mobile' : 'Desktop');
  console.log('[Init] Voice provider will be chosen automatically');
} catch(error){ showError('Ошибка инициализации: ' + error.message); }

if('speechSynthesis' in window) {
  speechSynthesis.addEventListener('voiceschanged', () => { getRuVoice(); });
  speechSynthesis.getVoices();
}

});
</script>
</body>
</html>
